const fs = require('fs-extra')
const path = require('path')
const { withOutputPath } = require('./utils')

module.exports.addGatsbyFiles = profile => {
  function replaceTemplate(content) {
    return content
      .replace(/{{ mediumUsername }}/g, profile.mediumUsername || '')
      .replace(/{{ authorName }}/g, profile.authorName || '')
      .replace(/{{ authorEmail }}/g, profile.authorEmail || '')
      .replace(/{{ twitterUsername }}/g, profile.twitterUsername || '')
      .replace(/{{ facebookUsername }}/g, profile.facebookUsername || '')
      .replace(/{{ bio }}/g, profile.bio || '')
  }

  function copyTemplate(fileName) {
    return fs
      .readFile(path.join(__dirname, `../gatsby-template/${fileName}`), 'utf8')
      .then(replaceTemplate)
      .then(content =>
        fs.writeFile(withOutputPath(profile, `./${fileName}`), content)
      )
  }

  return Promise.all([
    copyTemplate('README.md'),
    copyTemplate('package.json'),
    copyTemplate('netlify.toml'),
    copyTemplate('gatsby-ssr.js'),
    copyTemplate('gatsby-node.js'),
    copyTemplate('gatsby-config.js'),
    copyTemplate('gatsby-browser.js'),
    copyTemplate('Dockerfile'),
    copyTemplate('config.js'),
    copyTemplate('.travis.yml'),
    fs.writeFile(
      withOutputPath(profile, '.gitignore'),
      `# Logs
logs
*.log
npm-debug.log*
yarn-debug.log*
yarn-error.log*

# Runtime data
pids
*.pid
*.seed
*.pid.lock

# Directory for instrumented libs generated by jscoverage/JSCover
lib-cov

# Coverage directory used by tools like istanbul
coverage

# nyc test coverage
.nyc_output

# Grunt intermediate storage (http://gruntjs.com/creating-plugins#storing-task-files)
.grunt

# Bower dependency directory (https://bower.io/)
bower_components

# node-waf configuration
.lock-wscript

# Compiled binary addons (http://nodejs.org/api/addons.html)
build/Release

# Dependency directories
node_modules/
jspm_packages/

# Typescript v1 declaration files
typings/

# Optional npm cache directory
.npm

# Optional eslint cache
.eslintcache

# Optional REPL history
.node_repl_history

# Output of 'npm pack'
*.tgz

# dotenv environment variables file
.env

# gatsby files
.cache/
public

# Mac files
.DS_Store

# Yarn
yarn-error.log
.pnp/
.pnp.js
# Yarn Integrity file
.yarn-integrity
`
    ),
    copyTemplate('.eslintrc.yml'),
    copyTemplate('.dockerignore'),
    fs.copy(
      path.join(__dirname, '../gatsby-template/src'),
      withOutputPath(profile, './src')
    ),
    fs.copy(
      path.join(__dirname, '../gatsby-template/static'),
      withOutputPath(profile, './static')
    ),
  ])
}
